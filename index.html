<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LiuLab每日运动打卡</title>
  <style>
    :root { --bg:#0b1220; --panel:#111a2b; --muted:#7f8ca6; --text:#ecf2ff; --accent:#4da3ff; --ok:#15c27b; --warn:#ff8370; --border:#20304d; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC",Helvetica,Arial,"Microsoft Yahei",sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0b1220,rgba(11,18,32,.85));backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .title{display:flex;align-items:center;gap:12px}
    .title h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-top:10px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button,select,input,label.btnlike{background:#0f1730;color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    input[type="text"],input[type="date"],input[type="number"],input[type="password"],input[type="email"]{cursor:text}
    button:hover,label.btnlike:hover{border-color:#335287}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0f1730;color:var(--muted);font-size:12px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;text-align:left;border-bottom:1px dashed var(--border);vertical-align:middle}
    .table th{color:var(--muted);font-weight:600}
    .name-input{width:100%;background:transparent;border:none;outline:none;color:var(--text);padding:6px 8px;border:1px solid transparent;border-radius:8px}
    .name-input:hover,.name-input:focus{border-color:#2d4169;background:#0f1730}
    .name-input[readonly]{opacity:.85}
    .switch{position:relative;width:48px;height:28px;background:#2b3a5c;border-radius:999px;border:1px solid var(--border);transition:.2s}
    .switch::after{content:"";position:absolute;top:2px;left:2px;width:22px;height:22px;background:#9aa8c4;border-radius:50%;transition:.2s}
    .switch.on{background:#143a2b;border-color:#1d6d4f}
    .switch.on::after{left:24px;background:#27d88f}
    .center{display:flex;align-items:center;justify-content:center;gap:6px}
    .right{text-align:right}
    .ok{color:var(--ok)}
    .tabs{display:flex;gap:6px}
    .tabbtn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0f1730;color:var(--text);cursor:pointer}
    .tabbtn.active{outline:2px solid #355a92}
    .calendar-head{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-cell{border:1px solid var(--border);border-radius:12px;padding:10px;min-height:76px;background:#0f1730;position:relative}
    .cal-date{font-size:12px;color:var(--muted)}
    .cal-mark{position:absolute;right:10px;top:8px;font-size:14px}
    .mark-done{color:var(--ok)}
    .mark-note{color:var(--accent);margin-left:6px}
    .cal-actions{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
    .tiny{font-size:12px;padding:4px 6px}
    .week-grid{overflow-x:auto}
    .week-table{width:100%;border-collapse:collapse}
    .week-table th,.week-table td{padding:10px;border-bottom:1px dashed var(--border);text-align:center}
    .footer{color:var(--muted);font-size:12px;margin-top:24px}
    .status{display:inline-flex;gap:6px;align-items:center}
    .status-dot{width:8px;height:8px;border-radius:50%}
    .dot-off{background:#6b7280}
    .dot-on{background:#10b981}
    @media print{header,.no-print{display:none!important}body{background:#fff;color:#000}.card{border-color:#ccc}.table th,.table td{border-bottom-color:#ddd}}
    #dbg{position:fixed;bottom:8px;left:8px;background:#1a2236;border:1px solid #2a3b63;border-radius:8px;padding:6px 8px;font-size:12px;color:#9fb4ff;opacity:.9}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M8 2v2M16 2v2M3 9h18M5 5h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="#9fb4ff" stroke-width="1.3" stroke-linecap="round"/></svg>
        <h1>LiuLab每日运动打卡</h1>
        <span class="muted">支持房间多人实时同步；管理员可增删成员，普通用户可修改自己的姓名</span>
      </div>
      <div class="bar">
        <div class="controls card">
          <button id="prevDay">◀ 上一天</button>
          <label class="btnlike" for="datePick"><span class="muted">选择日期</span></label>
          <input id="datePick" type="date" />
          <button id="nextDay">下一天 ▶</button>
          <button id="goToday">今天</button>
          <span id="weekday" class="pill"></span>
          <span id="todaySummary" class="pill"></span>
        </div>
        <div class="controls card no-print">
          <span class="muted">成员设置（仅管理员可改人数/增删）：</span>
          <label>人数 <input id="memberCount" type="number" min="1" max="200" style="width:80px"/></label>
          <button id="applyMemberCount">应用</button>
          <button id="resetAll" class="warn">重置本地缓存</button>
        </div>
        <div class="controls card no-print" id="cloudPanel">
          <span class="muted">云同步（Supabase 实时）</span>
          <label>房间码 <input id="roomIdInput" type="text" placeholder="如 lab-2025" style="width:120px"></label>
          <label>URL <input id="supaUrl" type="text" placeholder="https://xxxx.supabase.co" style="width:220px"></label>
          <label>Anon Key <input id="supaKey" type="password" placeholder="复制你的匿名密钥" style="width:220px"></label>
          <button id="connectCloud">连接</button>
          <span class="status"><span id="cloudDot" class="status-dot dot-off"></span><span id="cloudStatus" class="muted">离线</span></span>
        </div>
        <div class="controls card no-print" id="accountPanel">
          <span class="muted">账号</span>
          <label>Email <input id="adminEmail" type="email" placeholder="you@example.com" style="width:200px"></label>
          <label>Password <input id="adminPass" type="password" placeholder="不少于6位" style="width:150px"></label>
          <button id="adminLogin">登录/注册</button>
          <button id="adminLogout">退出</button>
          <span id="adminInfo" class="pill">未登录</span>
          <label>我的编号 <select id="myOrdSelect" style="width:90px"></select></label>
          <button id="bindMyOrd">绑定我的行</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <table class="table" id="peopleTable">
        <thead>
          <tr>
            <th style="width:60px">#</th>
            <th>姓名（管理员或本人可改）</th>
            <th style="width:160px">今天运动？</th>
            <th style="width:220px">今日项目</th>
            <th class="right" style="width:120px">本周累计</th>
            <th class="right" style="width:120px">本月累计</th>
          </tr>
        </thead>
        <tbody id="peopleBody"></tbody>
      </table>
    </section>

    <section class="card">
      <div class="calendar-head">
        <div class="tabs no-print">
          <button class="tabbtn active" id="tabWeek">周视图</button>
          <button class="tabbtn" id="tabMonth">月视图</button>
        </div>
        <div class="controls">
          <label>成员 <select id="personSelect"></select></label>
        </div>
        <div class="controls" id="weekNav">
          <button id="prevWeek">◀ 上一周</button>
          <button id="thisWeek">本周</button>
          <button id="nextWeek">下一周 ▶</button>
          <span id="weekRange" class="pill"></span>
        </div>
        <div class="controls" id="monthNav" style="display:none">
          <button id="prevMonth">◀ 上一月</button>
          <button id="thisMonth">本月</button>
          <button id="nextMonth">下一月 ▶</button>
          <span id="monthLabel" class="pill"></span>
        </div>
      </div>
      <div id="weekView" class="week-grid">
        <table class="week-table">
          <thead><tr id="weekHeadRow"></tr></thead>
          <tbody><tr id="weekBodyRow"></tr></tbody>
        </table>
      </div>
      <div id="monthView" style="display:none">
        <div class="calendar-grid" id="monthGrid"></div>
      </div>
    </section>

    <p class="footer">默认本地 LocalStorage；填写 Supabase 与房间码可开启**多人实时**。管理员可新增/删除成员并改名；普通用户登录并绑定“我的编号”后，只能修改自己的姓名。</p>
  </main>

  <div id="dbg" class="no-print" style="display:none"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  (function(){
    'use strict';

    // ===== 工具 =====
    const pad2 = n => String(n).padStart(2,'0');
    const fmt = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const CN_WEEK = ['周日','周一','周二','周三','周四','周五','周六'];
    const weekdayStr = d => CN_WEEK[d.getDay()];
    const cloneDate = d => new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const todayDate = () => cloneDate(new Date());
    const isValidDateStr = s => typeof s==='string' && /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(s);
    function parseDate(s){ if(!isValidDateStr(s)) return todayDate(); const [y,m,da]=s.split('-').map(Number); const d=new Date(y,m-1,da); return isNaN(d.getTime())? todayDate() : cloneDate(d); }
    function setDateInputToToday(input){ const t=todayDate(); try{ if('valueAsDate' in input) input.valueAsDate=t; }catch(_){} input.value=fmt(t); }
    function getWeekRange(d){ const day=d.getDay(); const diffToMon=(day+6)%7; const start=cloneDate(d); start.setDate(start.getDate()-diffToMon); const end=cloneDate(start); end.setDate(start.getDate()+6); return {start,end}; }

    // ===== 状态与云配置 =====
    const STORAGE_KEY='exercise-tracker-v5';
    const DEFAULT_PEOPLE=(n=20)=>Array.from({length:n},(_,i)=>`成员${i+1}`);
    let state={ people: DEFAULT_PEOPLE(20), records:{} };

    let ROOM = localStorage.getItem('room_id') || '';
    let SUPA_URL = localStorage.getItem('supa_url') || '';
    let SUPA_KEY = localStorage.getItem('supa_key') || '';
    let sb = null; let connected=false;

    // 登录/权限
    let sessionUser = null; // { id, email }
    let isAdmin = false;
    let myOrd = null; // 我绑定的行（1-based）

    // ===== 本地存取 =====
    function loadLocal(){ try{ const raw=localStorage.getItem(STORAGE_KEY)||localStorage.getItem('exercise-tracker-v4'); if(raw){ const obj=JSON.parse(raw); if(Array.isArray(obj.people)&&obj.people.length>0) state.people=obj.people; if(obj.records&&typeof obj.records==='object') state.records=obj.records; } }catch(e){ log('加载失败:'+e.message);} }
    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    // ===== Supabase 连接 =====
    async function connectSupabase(){
      if(!SUPA_URL || !SUPA_KEY){ setCloudStatus(false,'离线（未配置）'); return false; }
      try{
        sb = supabase.createClient(SUPA_URL, SUPA_KEY);
        const { error } = await sb.from('people').select('room_id',{ head:true, count:'exact' }).limit(1);
        if(error){ setCloudStatus(false,'连接失败：'+error.message); return false; }
        setCloudStatus(true, ROOM? '在线 · 房间：'+ROOM : '在线（未加入房间）');
        connected = true;
        const { data:{ session } } = await sb.auth.getSession();
        sessionUser = session?.user || null;
        await resolveAdminByRoom();
        await loadMyOrd();
        updateAccountUI();
        return true;
      }catch(err){ setCloudStatus(false,'异常：'+err.message); return false; }
    }

    function setCloudStatus(on,msg){ const dot=document.getElementById('cloudDot'); const st=document.getElementById('cloudStatus'); dot.classList.toggle('dot-on',!!on); dot.classList.toggle('dot-off',!on); st.textContent=msg; }

    // ===== DOM =====
    const datePick=document.getElementById('datePick');
    const weekdayEl=document.getElementById('weekday');
    const peopleBody=document.getElementById('peopleBody');
    const todaySummary=document.getElementById('todaySummary');
    const memberCountInput=document.getElementById('memberCount');
    const applyMemberBtn=document.getElementById('applyMemberCount');
    const personSelect=document.getElementById('personSelect');
    const weekHeadRow=document.getElementById('weekHeadRow');
    const weekBodyRow=document.getElementById('weekBodyRow');
    const weekRangeEl=document.getElementById('weekRange');
    const monthGrid=document.getElementById('monthGrid');
    const monthLabel=document.getElementById('monthLabel');
    const tabWeek=document.getElementById('tabWeek');
    const tabMonth=document.getElementById('tabMonth');
    const weekView=document.getElementById('weekView');
    const monthView=document.getElementById('monthView');
    const weekNav=document.getElementById('weekNav');
    const monthNav=document.getElementById('monthNav');
    const roomIdInput=document.getElementById('roomIdInput');
    const supaUrlInput=document.getElementById('supaUrl');
    const supaKeyInput=document.getElementById('supaKey');
    const connectBtn=document.getElementById('connectCloud');
    const adminEmailInput=document.getElementById('adminEmail');
    const adminPassInput=document.getElementById('adminPass');
    const adminLoginBtn=document.getElementById('adminLogin');
    const adminLogoutBtn=document.getElementById('adminLogout');
    const adminInfo=document.getElementById('adminInfo');
    const myOrdSelect=document.getElementById('myOrdSelect');
    const bindMyOrdBtn=document.getElementById('bindMyOrd');

    // ===== 调试显示 =====
    const dbg=document.getElementById('dbg');
    function log(msg){ dbg.style.display='block'; dbg.textContent=String(msg); console.warn('[debug]', msg); }
    window.addEventListener('error', e=>{ log('脚本错误：'+(e.message||e)); });

    // ===== 数据结构 =====
    const isObjEntry = e => !!e && typeof e==='object' && ('done' in e || 'item' in e);
    const getDone = e => isObjEntry(e)? !!e.done : !!e;
    const getItem = e => isObjEntry(e)? (e.item||'') : '';
    function ensureDay(dateStr){ const n=state.people.length; if(!n) return; if(!state.records[dateStr] || !Array.isArray(state.records[dateStr]) || state.records[dateStr].length!==n){ const arr=Array.from({length:n},()=>({done:false,item:''})); const old=state.records[dateStr]; if(Array.isArray(old)){ for(let i=0;i<Math.min(old.length,n);i++){ const e=old[i]; arr[i]=isObjEntry(e)? {done:!!e.done,item:(e.item||'')} : {done:!!e,item:''}; } } state.records[dateStr]=arr; } else { state.records[dateStr]=state.records[dateStr].map(e=>isObjEntry(e)? e : {done:!!e,item:''}); } }
    function setDone(dateStr,i,val){ ensureDay(dateStr); state.records[dateStr][i].done=!!val; saveLocal(); if(connected && ROOM) upsertRecordCloud(dateStr,i,state.records[dateStr][i]); }
    function setItem(dateStr,i,text){ ensureDay(dateStr); state.records[dateStr][i].item=String(text||''); saveLocal(); if(connected && ROOM) upsertRecordCloud(dateStr,i,state.records[dateStr][i]); }
    function personRangeCount(i,startDate,endDate){ let cnt=0; const d=cloneDate(startDate); while(d<=endDate){ const k=fmt(d); const arr=state.records[k]; if(arr && arr[i] && getDone(arr[i])) cnt++; d.setDate(d.getDate()+1);} return cnt; }

    // ===== 权限辅助 =====
    const canEditNameRow = (i) => isAdmin || (!!sessionUser && myOrd === i+1);

    // ===== 渲染：日表格 =====
    function renderTable(){ if(!isValidDateStr(datePick.value)) setDateInputToToday(datePick); const dateStr=datePick.value; ensureDay(dateStr); const arr=state.records[dateStr]; peopleBody.innerHTML=''; let doneCount=0; const d=parseDate(dateStr); weekdayEl.textContent = `${weekdayStr(d)}（${fmt(d)}）`; const {start:weekStart,end:weekEnd}=getWeekRange(d); const monthStart=new Date(d.getFullYear(),d.getMonth(),1); const monthEnd=new Date(d.getFullYear(),d.getMonth()+1,0);
      for(let i=0;i<state.people.length;i++){
        const e=arr[i]; const done=getDone(e); if(done) doneCount++; const item=getItem(e);
        const tr=document.createElement('tr');
        const tdIdx=document.createElement('td'); tdIdx.textContent=i+1; tr.appendChild(tdIdx);
        const tdName=document.createElement('td'); const nameInput=document.createElement('input'); nameInput.className='name-input'; nameInput.type='text'; nameInput.value=state.people[i]; nameInput.placeholder=`成员${i+1}`; nameInput.readOnly=!canEditNameRow(i); nameInput.addEventListener('change',async()=>{ const newName=(nameInput.value.trim()||`成员${i+1}`); if(!canEditNameRow(i)){ nameInput.value=state.people[i]; return; } state.people[i]=newName; saveLocal(); renderPersonSelect(); if(connected && ROOM){ if(isAdmin){ await syncPeopleCloud(); } else { await updatePersonNameCloud(i+1,newName); } } }); tdName.appendChild(nameInput); tr.appendChild(tdName);
        const tdCheck=document.createElement('td'); tdCheck.className='center'; const sw=document.createElement('div'); sw.setAttribute('role','switch'); sw.className='switch'+(done?' on':''); sw.addEventListener('click',()=>{ const nv=!getDone(state.records[dateStr][i]); setDone(dateStr,i,nv); sw.classList.toggle('on',nv); renderSummary();}); tdCheck.appendChild(sw); tr.appendChild(tdCheck);
        const tdItem=document.createElement('td'); const itemInput=document.createElement('input'); itemInput.className='name-input'; itemInput.type='text'; itemInput.placeholder='如：跑步20分钟 / 骑行5km'; itemInput.value=item; itemInput.addEventListener('change',()=>{ setItem(dateStr,i,itemInput.value);}); tdItem.appendChild(itemInput); tr.appendChild(tdItem);
        const tdWeek=document.createElement('td'); tdWeek.className='right'; tdWeek.innerHTML=`<span class="pill">${personRangeCount(i,weekStart,weekEnd)} 次</span>`; tr.appendChild(tdWeek);
        const tdMonth=document.createElement('td'); tdMonth.className='right'; tdMonth.innerHTML=`<span class="pill">${personRangeCount(i,monthStart,monthEnd)} 次</span>`; tr.appendChild(tdMonth);
        peopleBody.appendChild(tr);
      }
      todaySummary.innerHTML=`本日完成：<b class="ok">${doneCount}</b> / ${state.people.length}`;
      updateUIEnables();
    }
    function renderSummary(){ const dateStr=isValidDateStr(datePick.value)? datePick.value : fmt(todayDate()); const arr=state.records[dateStr]||[]; const done=arr.filter(e=>getDone(e)).length; todaySummary.innerHTML=`本日完成：<b class="ok">${done}</b> / ${state.people.length}`; }

    // ===== 周、月视图 =====
    let weekRef=todayDate();
    function renderWeek(){ const {start,end}=getWeekRange(weekRef); weekRangeEl.textContent=`${fmt(start)} 至 ${fmt(end)}`; let headHtml='<th>成员</th>'; for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); headHtml += `<th>${CN_WEEK[d.getDay()]}<br>${pad2(d.getMonth()+1)}-${pad2(d.getDate())}</th>`; } weekHeadRow.innerHTML=headHtml; const idx=Math.max(0,Math.min(personSelect.selectedIndex,state.people.length-1)); const name=state.people[idx]||`成员${idx+1}`; let rowHtml=`<td><span class="pill">${name}</span></td>`; for(let i=0;i<7;i++){ const d=new Date(start); d.setDate(start.getDate()+i); const k=fmt(d); ensureDay(k); const entry=state.records[k][idx]; const done=getDone(entry); const note=getItem(entry); const noteHtml = note? `<span class="pill">${(note.length>14? note.slice(0,14)+'…' : note)}</span>` : ''; rowHtml += `<td data-day="${k}" data-i="${idx}"><div class="center"><div class="switch ${done?'on':''}"></div></div><div style="margin-top:6px;">${noteHtml}</div></td>`; } weekBodyRow.innerHTML=rowHtml; weekBodyRow.querySelectorAll('td[data-day] .switch').forEach(sw=>{ sw.addEventListener('click',e=>{ const cell=e.target.closest('td[data-day]'); const k=cell.getAttribute('data-day'); const i=Number(cell.getAttribute('data-i')); const cur=state.records[k][i]; const nv=!getDone(cur); setDone(k,i,nv); sw.classList.toggle('on',nv); renderSummary(); }); }); weekBodyRow.querySelectorAll('td[data-day]').forEach(cell=>{ cell.addEventListener('dblclick',()=>{ const k=cell.getAttribute('data-day'); const i=Number(cell.getAttribute('data-i')); const curItem=getItem(state.records[k][i]); const txt=prompt('填写/修改该日项目：',curItem); if(txt!==null){ setItem(k,i,txt); renderWeek(); }}); }); }

    let monthRef=todayDate();
    function renderMonth(){ const y=monthRef.getFullYear(); const m=monthRef.getMonth(); monthLabel.textContent=`${y}年${pad2(m+1)}月`; monthGrid.innerHTML=''; const first=new Date(y,m,1); const last=new Date(y,m+1,0); const prefix=(first.getDay()+6)%7; const total=prefix+last.getDate(); const cells=Math.ceil(total/7)*7; const idx=Math.max(0,Math.min(personSelect.selectedIndex,state.people.length-1)); for(let i=0;i<cells;i++){ const cell=document.createElement('div'); cell.className='cal-cell'; const dayNum=i-prefix+1; if(dayNum>=1 && dayNum<=last.getDate()){ const d=new Date(y,m,dayNum); const k=fmt(d); ensureDay(k); const entry=state.records[k][idx]; const done=getDone(entry); const note=getItem(entry); const top=document.createElement('div'); top.className='cal-date'; top.textContent=`${CN_WEEK[d.getDay()]} ${pad2(m+1)}-${pad2(dayNum)}`; cell.appendChild(top); const mark=document.createElement('div'); mark.className='cal-mark'; mark.innerHTML=(done?'<span class="mark-done">✔</span>':'')+(note?'<span class="mark-note">✎</span>':''); cell.appendChild(mark); const actions=document.createElement('div'); actions.className='cal-actions'; const btnToggle=document.createElement('button'); btnToggle.className='tiny'; btnToggle.textContent=done?'取消运动':'标记运动'; btnToggle.addEventListener('click',()=>{ setDone(k,idx,!done); renderMonth(); renderSummary(); }); const btnEdit=document.createElement('button'); btnEdit.className='tiny'; btnEdit.textContent=note?'编辑项目':'填写项目'; btnEdit.addEventListener('click',()=>{ const txt=prompt(`${k} 项目：`,note); if(txt!==null){ setItem(k,idx,txt); renderMonth(); }}); actions.appendChild(btnToggle); actions.appendChild(btnEdit); cell.appendChild(actions); } else { cell.style.visibility='hidden'; } monthGrid.appendChild(cell); } }

    // ===== 渲染总控 =====
    function renderPersonSelect(){ const sel=Math.max(0,Math.min(personSelect.selectedIndex,state.people.length-1)); personSelect.innerHTML=state.people.map((n,i)=>`<option value="${i}">${n}</option>`).join(''); personSelect.selectedIndex=Math.min(sel,state.people.length-1); refreshMyOrdSelect(); }
    function renderAll(){ if(!isValidDateStr(datePick.value)) setDateInputToToday(datePick); memberCountInput.value=state.people.length; renderPersonSelect(); renderTable(); renderWeek(); renderMonth(); }

    function updateUIEnables(){ memberCountInput.disabled = !isAdmin; applyMemberBtn.disabled = !isAdmin; adminInfo.textContent = sessionUser? (isAdmin? `管理员：${sessionUser.email}` : `已登录：${sessionUser.email}`) : '未登录'; bindMyOrdBtn.disabled = !(sessionUser && ROOM && connected); myOrdSelect.disabled = !(sessionUser && ROOM && connected); }

    function refreshMyOrdSelect(){ const n=state.people.length; const opts=Array.from({length:n},(_,i)=>`<option value="${i+1}">${i+1} — ${state.people[i]}</option>`).join(''); myOrdSelect.innerHTML = opts; if(myOrd){ myOrdSelect.value = String(myOrd); } }

    // ===== 人数调整（仅管理员） =====
    function resizePeople(newCount){ if(!isAdmin){ alert('仅管理员可修改成员人数'); return; } const oldCount=state.people.length; let n=parseInt(newCount,10); if(!n||n<1) n=oldCount; n=Math.min(200,Math.max(1,n)); if(n===oldCount){ memberCountInput.value=n; renderAll(); return; } if(n>oldCount){ for(let i=oldCount;i<n;i++) state.people.push(`成员${i+1}`); } else { state.people=state.people.slice(0,n); if(myOrd && myOrd>n) myOrd=null; } for(const k of Object.keys(state.records)){ const arr=state.records[k]||[]; const norm=Array.from({length:n},(_,i)=>{ if(i<arr.length){ const e=arr[i]; return isObjEntry(e)? {done:!!e.done,item:(e.item||'')} : {done:!!e,item:''}; } return {done:false,item:''}; }); state.records[k]=norm; } saveLocal(); renderAll(); if(connected && ROOM) syncPeopleCloud(); }

    // ===== 初始化 =====
    try{
      loadLocal();
      setDateInputToToday(datePick);
      roomIdInput.value = ROOM; supaUrlInput.value = SUPA_URL; supaKeyInput.value = SUPA_KEY;
      // 这里修复了 IIFE 花括号遗漏导致的 ")" 语法错误：补上外层 if 的 "}"
      (async()=>{
        if(SUPA_URL && SUPA_KEY){
          const ok = await connectSupabase();
          if(ok && ROOM){
            await hydrateFromCloud();
            setupRealtime();
          }
        }
      })();
      renderAll();
    }catch(e){ log('初始化异常：'+e.message); }

    // ===== 事件绑定 =====
    document.getElementById('prevDay').addEventListener('click',()=>{ const d=parseDate(datePick.value); d.setDate(d.getDate()-1); datePick.value=fmt(d); renderAll(); });
    document.getElementById('nextDay').addEventListener('click',()=>{ const d=parseDate(datePick.value); d.setDate(d.getDate()+1); datePick.value=fmt(d); renderAll(); });
    document.getElementById('goToday').addEventListener('click',()=>{ setDateInputToToday(datePick); renderAll(); });
    datePick.addEventListener('change',()=>{ if(!isValidDateStr(datePick.value)) setDateInputToToday(datePick); renderAll(); });

    document.getElementById('resetAll').addEventListener('click',()=>{ if(confirm('仅清除本地缓存（不影响云端），确定吗？')){ state={people:DEFAULT_PEOPLE(),records:{}}; saveLocal(); renderAll(); }});

    applyMemberBtn.addEventListener('click',()=>{ resizePeople(memberCountInput.value); });
    memberCountInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ resizePeople(memberCountInput.value); }});

    document.getElementById('prevWeek').addEventListener('click',()=>{ weekRef.setDate(weekRef.getDate()-7); renderWeek(); });
    document.getElementById('nextWeek').addEventListener('click',()=>{ weekRef.setDate(weekRef.getDate()+7); renderWeek(); });
    document.getElementById('thisWeek').addEventListener('click',()=>{ weekRef=todayDate(); renderWeek(); });
    document.getElementById('prevMonth').addEventListener('click',()=>{ monthRef.setMonth(monthRef.getMonth()-1); renderMonth(); });
    document.getElementById('nextMonth').addEventListener('click',()=>{ monthRef.setMonth(monthRef.getMonth()+1); renderMonth(); });
    document.getElementById('thisMonth').addEventListener('click',()=>{ monthRef=todayDate(); renderMonth(); });

    function setTab(which){ if(which==='week'){ tabWeek.classList.add('active'); tabMonth.classList.remove('active'); weekView.style.display='block'; monthView.style.display='none'; weekNav.style.display='flex'; monthNav.style.display='none'; } else { tabMonth.classList.add('active'); tabWeek.classList.remove('active'); weekView.style.display='none'; monthView.style.display='block'; weekNav.style.display='none'; monthNav.style.display='flex'; } }
    tabWeek.addEventListener('click',()=>setTab('week'));
    tabMonth.addEventListener('click',()=>setTab('month'));
    personSelect.addEventListener('change',()=>{ renderWeek(); renderMonth(); });

    // 账号登录
    adminLoginBtn.addEventListener('click', async ()=>{
      if(!connected){ alert('请先连接 Supabase'); return; }
      const email = adminEmailInput.value.trim(); const pass = adminPassInput.value.trim(); if(!email || pass.length<6){ alert('请输入有效邮箱与6位以上密码'); return; }
      let { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
      if(error){ const ok = confirm('登录失败，是否注册并登录？'); if(!ok) return; const res = await sb.auth.signUp({ email, password: pass }); if(res.error){ alert('注册失败：'+res.error.message); return; } ({ data, error } = await sb.auth.signInWithPassword({ email, password: pass })); if(error){ alert('登录仍失败：'+error.message); return; } }
      sessionUser = data.user; await resolveAdminByRoom(); await loadMyOrd(); updateAccountUI(); alert(isAdmin? '管理员登录成功' : '登录成功');
    });

    adminLogoutBtn.addEventListener('click', async ()=>{ if(connected){ await sb.auth.signOut(); } sessionUser=null; isAdmin=false; myOrd=null; updateAccountUI(); renderAll(); });

    // 绑定我的行
    bindMyOrdBtn.addEventListener('click', async ()=>{
      if(!sessionUser || !ROOM || !connected){ alert('请先连接并登录'); return; }
      const ord = parseInt(myOrdSelect.value,10);
      const { error } = await sb.from('members').upsert({ room_id: ROOM, uid: sessionUser.id, ord }, { onConflict: 'room_id,uid' });
      if(error){ alert('绑定失败：'+error.message); return; }
      myOrd = ord; updateAccountUI(); renderAll(); alert('已绑定到第 '+ord+' 行');
    });

    function updateAccountUI(){ refreshMyOrdSelect(); updateUIEnables(); }

    // ===== 云端：读写 & 实时 =====
    async function hydrateFromCloud(){ try{ const { data: ppl } = await sb.from('people').select('ord,name').eq('room_id',ROOM).order('ord'); if(ppl && ppl.length>0){ const maxOrd = Math.max(...ppl.map(p=>p.ord)); state.people = Array.from({length:maxOrd},(_,i)=> (ppl.find(p=>p.ord===i+1)?.name || `成员${i+1}`)); } else { await syncPeopleCloud(); } const d = parseDate(datePick.value); await loadMonthCloud(d.getFullYear(), d.getMonth()+1); renderAll(); }catch(err){ log('hydrate异常：'+err.message); }}

    async function syncPeopleCloud(){ const rows = state.people.map((name,idx)=>({room_id:ROOM, ord:idx+1, name})); const { error } = await sb.from('people').upsert(rows, { onConflict:'room_id,ord' }); if(error) log('上传成员失败：'+error.message); }

    async function updatePersonNameCloud(ord, name){ const { error } = await sb.from('people').upsert({room_id:ROOM, ord, name}, { onConflict:'room_id,ord' }); if(error) log('更新姓名失败：'+error.message); }

    async function loadMonthCloud(year, month){ const ym = String(month).padStart(2,'0'); const from = `${year}-${ym}-01`; const to = `${year}-${ym}-31`; const { data, error } = await sb.from('records').select('date,ord,done,item').eq('room_id',ROOM).gte('date',from).lte('date',to); if(error){ log('拉取记录失败：'+error.message); return; } const d0 = new Date(year, month-1, 1); const last = new Date(year, month, 0); const byKey = new Map(); data.forEach(r=>{ const k = `${r.date}`; const arr = byKey.get(k) || []; arr[r.ord-1] = {done:!!r.done,item:r.item||''}; byKey.set(k, arr); }); const cur = new Date(d0); while(cur<=last){ const k=fmt(cur); const n=state.people.length; const arr=Array.from({length:n},(_,i)=> ({done:false,item:''})); const has = byKey.get(k)||[]; for(let i=0;i<n;i++){ if(has[i]) arr[i]=has[i]; } state.records[k]=arr; cur.setDate(cur.getDate()+1);} saveLocal(); }

    async function upsertRecordCloud(dateStr, ordIndex, entry){ const { error } = await sb.from('records').upsert({ room_id:ROOM, date:dateStr, ord:ordIndex+1, done:!!entry.done, item: entry.item||'' }, { onConflict:'room_id,date,ord' }); if(error) log('写入记录失败：'+error.message); }

    async function resolveAdminByRoom(){ if(!connected || !ROOM){ isAdmin=false; return; } try{ const { data, error } = await sb.from('rooms').select('admin_uid').eq('room_id',ROOM).maybeSingle(); if(error && error.code!=='PGRST116'){ log('查询房间失败：'+error.message); isAdmin=false; return; } if(!data){ if(sessionUser){ await sb.from('rooms').insert({room_id:ROOM, admin_uid:sessionUser.id}); isAdmin=true; } else { isAdmin=false; } } else { isAdmin = !!sessionUser && data.admin_uid === sessionUser.id; } }catch(err){ log('resolveAdmin异常：'+err.message); isAdmin=false; }
    }

    async function loadMyOrd(){ if(!connected || !ROOM || !sessionUser){ myOrd=null; return; } const { data, error } = await sb.from('members').select('ord').eq('room_id',ROOM).eq('uid',sessionUser.id).maybeSingle(); if(error && error.code!=='PGRST116'){ log('查询我的编号失败：'+error.message); } myOrd = data?.ord || null; }

    function setupRealtime(){ sb.channel('realtime:records').on('postgres_changes', { event:'*', schema:'public', table:'records', filter:`room_id=eq.${ROOM}` }, payload=>{ const r = payload.new || payload.old; if(!r) return; const k = r.date; ensureDay(k); const idx=r.ord-1; if(payload.eventType==='DELETE'){ state.records[k][idx] = {done:false,item:''}; } else { state.records[k][idx] = {done:!!r.done, item:r.item||''}; } saveLocal(); renderSummary(); if(k===datePick.value) renderTable(); renderWeek(); renderMonth(); }).subscribe(); sb.channel('realtime:people').on('postgres_changes', { event:'*', schema:'public', table:'people', filter:`room_id=eq.${ROOM}` }, ()=>{ hydrateFromCloud(); }).subscribe(); setCloudStatus(true,'在线 · 房间：'+ROOM); }

    // Cloud connect
    connectBtn.addEventListener('click', async ()=>{
      ROOM = roomIdInput.value.trim(); SUPA_URL = supaUrlInput.value.trim(); SUPA_KEY = supaKeyInput.value.trim();
      localStorage.setItem('room_id', ROOM); localStorage.setItem('supa_url', SUPA_URL); localStorage.setItem('supa_key', SUPA_KEY);
      const ok = await connectSupabase(); if(ok){ if(ROOM){ await hydrateFromCloud(); setupRealtime(); await resolveAdminByRoom(); await loadMyOrd(); updateAccountUI(); } else { alert('已连接 Supabase，但未填写房间码'); } }
    });

    // ===== 自检（基础 + 权限） =====
    function runSelfTests(){
      try{
        const results = [];
        // 已有测试
        results.push(['T1 isValidDate', isValidDateStr(datePick.value)]);
        results.push(['T2 tableRows', peopleBody.children.length === state.people.length]);
        const dateStr = fmt(todayDate()); ensureDay(dateStr);
        const before = !!state.records[dateStr][0]?.done; setDone(dateStr,0,!before);
        const after = !!state.records[dateStr][0]?.done; setDone(dateStr,0,before);
        results.push(['T3 toggle', after === !before]);
        results.push(['T4 personSelectOptions', personSelect.options.length === state.people.length]);
        results.push(['T5 weekHead >=8', weekHeadRow.children.length >= 8]);
        results.push(['T6 monthGrid >0', monthGrid.children.length > 0]);
        results.push(['T7 nonAdminLockCount', (!isAdmin) ? (document.querySelectorAll('input.name-input[readonly]').length >= state.people.length - (myOrd?1:0)) : true]);
        // 新增测试
        const invalidParse = parseDate('bad-date');
        results.push(['T8 parseDate fallback today', fmt(invalidParse) === fmt(todayDate())]);
        const tempDate = new Date(2025,0,1); // 2025-01-01
        const wr = getWeekRange(tempDate); // 检查周一到周日窗口
        results.push(['T9 weekRange 7days', ( (wr.end - wr.start)/86400000 + 1 ) === 7 ]);
        const n0 = state.people.length; resizePeople(n0); // no-op
        results.push(['T10 resize no-op keeps length', state.people.length === n0]);
        console.table(results);
        if(!results.every(([,ok])=>ok)) log('自检未全部通过');
      }catch(err){ log('自检异常：'+err.message); }
    }
    runSelfTests();

  })();
  </script>
</body>
</html>
